/*!
 * Flippy v1.0.0 - Modern PDF Viewer
 * 
 * Copyright (c) 2025 Bobby Fajar Christian (@bobbyfajarc)
 * Licensed under the MIT License
 * 
 * GitHub: https://github.com/bobbyfajarc/flippypdf
 * License: https://github.com/bobbyfajarc/flippypdf/blob/main/LICENSE
 * 
 * Pure Vanilla JavaScript
 * 3 Display Modes: Book Flip, Webtoon, Single
 */
(function(){'use strict';const LOADING_MESSAGES=['üìñ Membuka buku...','‚ú® Menyiapkan halaman...','üé® Menata tampilan...','üìö Sebentar lagi siap...','‚ö° Hampir selesai...','üöÄ Siap dibaca!'];const FLIPPY_VERSION='1.0.0';const AUTHOR='Bobby Fajar Christian';const USERNAME='@bobbyfajarc';const LOCATION='Jakarta, Indonesia';const YEAR='2025';const sanitizeText=(text)=>{const div=document.createElement('div');div.textContent=text;return div.innerHTML};const debounce=(func,wait)=>{let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}};class Flippy{constructor(options={}){this.options=Object.assign({pdfUrl:null,mode:'book',title:'PDF Viewer',scale:2.0,pageWidth:450,pageHeight:600,minZoom:0.5,maxZoom:2.5,zoomStep:0.1,soundEnabled:!0,soundUrl:'dist/sound/turnPage.mp3',parallelRender:2,jpegQuality:0.92},options);this.options.title=sanitizeText(this.options.title);this.pdfDoc=null;this.totalPages=0;this.pageImages=[];this.pageDimensions=[];this.currentSpread=0;this.currentPage=0;this.currentZoom=1.0;this.isFlipping=!1;this.isFullyLoaded=!1;this.isPanning=!1;this.panOffsetX=0;this.panOffsetY=0;this.flipSound=null;this.audioLoaded=!1;this.loadingInterval=null;this.loadingIndex=0;this.overlay=null;this.cachedElements={};this.eventListeners=[];this.rafId=null;console.log(`%cüìñ Flippy v${FLIPPY_VERSION} by ${AUTHOR} (${USERNAME})`,'color: #3B82F6; font-size: 18px; font-weight: bold;');console.log(`%cüìç ${LOCATION} ¬∑ ${YEAR} ¬∑ OPTIMIZED BUILD`,'color: #4ade80;');if(typeof pdfjsLib==='undefined'){console.error('‚ùå PDF.js library not found!');return}}
createOverlay(){const titleSafe=this.options.title;const overlay=document.createElement('div');overlay.className='flippy-overlay';overlay.innerHTML=`
                <div class="flippy-container">
                    <div class="flippy-header">
                        <div class="flippy-title">
                            <i class="ri-book-open-line" aria-hidden="true"></i>
                            <span class="flippy-title-text"></span>
                        </div>
                        <div class="flippy-tools">
                            <button class="flippy-tool-btn flippy-zoom-out" title="Perkecil" disabled aria-label="Zoom Out">
                                <i class="ri-zoom-out-line" aria-hidden="true"></i>
                            </button>
                            <button class="flippy-tool-btn flippy-zoom-in" title="Perbesar" disabled aria-label="Zoom In">
                                <i class="ri-zoom-in-line" aria-hidden="true"></i>
                            </button>
                            <button class="flippy-tool-btn flippy-download" title="Unduh PDF" aria-label="Download PDF">
                                <i class="ri-download-2-line" aria-hidden="true"></i>
                            </button>
                            <button class="flippy-tool-btn flippy-fullscreen" title="Layar Penuh" aria-label="Fullscreen">
                                <i class="ri-fullscreen-line" aria-hidden="true"></i>
                            </button>
                            ${this.options.mode !== 'webtoon' ? `<button class="flippy-tool-btn flippy-toggle-sidebar" title="Daftar Isi" disabled aria-label="Toggle Sidebar"><i class="ri-list-unordered" aria-hidden="true"></i></button>` : ''}
                            ${this.options.soundEnabled && this.options.mode !== 'webtoon' ? `<button class="flippy-tool-btn flippy-toggle-sound" title="Suara" aria-label="Toggle Sound"><i class="ri-volume-up-line" aria-hidden="true"></i></button>` : ''}
                            <button class="flippy-tool-btn flippy-close" title="Tutup" aria-label="Close">
                                <i class="ri-close-line" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flippy-main">
                        <div class="flippy-viewer">
                            <div class="flippy-loading">
                                <div class="flippy-spinner"></div>
                                <p class="flippy-status">üìñ Membuka buku...</p>
                            </div>

                            <div class="flippy-book">
                                ${this.options.mode === 'book' ? '<div class="flippy-spine"></div>' : ''}
                                <div class="flippy-spreads"></div>
                            </div>

                            <div class="flippy-zoom-indicator"></div>
                        </div>

                        ${this.options.mode !== 'webtoon' ? `<div class="flippy-sidebar"><div class="flippy-sidebar-header"><h6><i class="ri-image-line" aria-hidden="true"></i>Daftar Halaman</h6><button class="flippy-sidebar-close" aria-label="Close Sidebar"><i class="ri-close-line" aria-hidden="true"></i></button></div><div class="flippy-thumbnails"></div></div>` : ''}
                    </div>

                    <div class="flippy-controls">
                        <button class="flippy-btn flippy-first" title="Halaman Pertama" disabled aria-label="First Page">
                            <i class="ri-skip-back-line" aria-hidden="true"></i>
                        </button>
                        <button class="flippy-btn flippy-prev" disabled aria-label="Previous Page">
                            <i class="ri-arrow-left-line" aria-hidden="true"></i>
                            <span>Sebelumnya</span>
                        </button>
                        
                        <div class="flippy-page-info">
                            <span class="flippy-page-display">-</span>
                        </div>
                        
                        <button class="flippy-btn flippy-next" disabled aria-label="Next Page">
                            <span>Berikutnya</span>
                            <i class="ri-arrow-right-line" aria-hidden="true"></i>
                        </button>
                        <button class="flippy-btn flippy-last" title="Halaman Terakhir" disabled aria-label="Last Page">
                            <i class="ri-skip-forward-line" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            `;document.body.appendChild(overlay);this.overlay=overlay;const titleEl=this.overlay.querySelector('.flippy-title-text');if(titleEl)titleEl.textContent=this.options.title}
bindControls(){this.addListener('.flippy-close','click',()=>this.close());this.addListener('.flippy-first','click',()=>this.firstPage());this.addListener('.flippy-prev','click',()=>this.prevPage());this.addListener('.flippy-next','click',()=>this.nextPage());this.addListener('.flippy-last','click',()=>this.lastPage());this.addListener('.flippy-zoom-in','click',()=>this.zoomIn());this.addListener('.flippy-zoom-out','click',()=>this.zoomOut());this.addListener('.flippy-fullscreen','click',()=>this.toggleFullscreen());this.addListener('.flippy-download','click',()=>{if(this.options.pdfUrl){const link=document.createElement('a');link.href=this.options.pdfUrl;link.target='_blank';link.rel='noopener noreferrer';link.click()}});if(this.options.mode!=='webtoon'){this.addListener('.flippy-toggle-sidebar','click',()=>{if(this.isFullyLoaded){this.query('.flippy-sidebar')?.classList.toggle('active')}});this.addListener('.flippy-sidebar-close','click',()=>{this.query('.flippy-sidebar')?.classList.remove('active')})}
if(this.options.soundEnabled&&this.options.mode!=='webtoon'){this.addListener('.flippy-toggle-sound','click',(e)=>{this.options.soundEnabled=!this.options.soundEnabled;const icon=e.currentTarget.querySelector('i');if(icon){icon.className=this.options.soundEnabled?'ri-volume-up-line':'ri-volume-mute-line'}})}
const keyHandler=(e)=>{if(!this.overlay?.classList.contains('active')||!this.isFullyLoaded)return;if(this.options.mode==='webtoon'){if(e.key==='ArrowDown'||e.key==='PageDown'){e.preventDefault();this.nextPage()}else if(e.key==='ArrowUp'||e.key==='PageUp'){e.preventDefault();this.prevPage()}else if(e.key==='Escape'){e.preventDefault();this.close()}
return}
switch(e.key){case 'Home':e.preventDefault();this.firstPage();break;case 'End':e.preventDefault();this.lastPage();break;case 'ArrowLeft':case 'PageUp':e.preventDefault();this.prevPage();break;case 'ArrowRight':case 'PageDown':e.preventDefault();this.nextPage();break;case 'Escape':e.preventDefault();document.fullscreenElement?document.exitFullscreen():this.close();break}};document.addEventListener('keydown',keyHandler);this.eventListeners.push({target:document,event:'keydown',handler:keyHandler});if(this.options.mode==='book'){this.addListener('.flippy-book','click',(e)=>{if(this.isFlipping||!this.isFullyLoaded||this.currentZoom>1.0)return;const rect=e.currentTarget.getBoundingClientRect();const clickX=e.clientX-rect.left;const halfWidth=rect.width/2;if(clickX<halfWidth){this.prevPage()}else{this.nextPage()}})}}
initPanAndZoom(){let isDragging=!1;let startX=0;let startY=0;const onMouseDown=(e)=>{if(!this.isFullyLoaded||this.isFlipping)return;if(this.currentZoom>1.0){isDragging=!0;startX=e.clientX-this.panOffsetX;startY=e.clientY-this.panOffsetY;document.body.style.cursor='grabbing';e.preventDefault()}};const onMouseMove=(e)=>{if(!isDragging)return;this.panOffsetX=e.clientX-startX;this.panOffsetY=e.clientY-startY;if(this.rafId)cancelAnimationFrame(this.rafId);this.rafId=requestAnimationFrame(()=>this.applyZoom());e.preventDefault()};const onMouseUp=()=>{if(isDragging){isDragging=!1;document.body.style.cursor='default';if(this.options.mode==='webtoon'){this.queryAll('.flippy-webtoon-zoom-wrapper').forEach(w=>{w.style.cursor=this.currentZoom>1.0?'grab':'default'})}else if(this.options.mode==='single'){this.queryAll('.flippy-single-zoom-wrapper').forEach(w=>{w.style.cursor=this.currentZoom>1.0?'grab':'default'})}}};const onMouseLeave=()=>{if(isDragging){isDragging=!1;document.body.style.cursor='default'}};const viewer=this.query('.flippy-viewer');if(viewer){viewer.addEventListener('mousedown',onMouseDown);this.eventListeners.push({target:viewer,event:'mousedown',handler:onMouseDown})}
document.addEventListener('mousemove',onMouseMove);document.addEventListener('mouseup',onMouseUp);document.addEventListener('mouseleave',onMouseLeave);this.eventListeners.push({target:document,event:'mousemove',handler:onMouseMove});this.eventListeners.push({target:document,event:'mouseup',handler:onMouseUp});this.eventListeners.push({target:document,event:'mouseleave',handler:onMouseLeave});const wheelHandler=(e)=>{if(!this.isFullyLoaded)return;if(this.options.mode==='webtoon'||this.options.mode==='single'){e.preventDefault();if(e.deltaY>0){this.nextPage()}else{this.prevPage()}}else if(this.options.mode==='book'){e.preventDefault();e.deltaY<0?this.zoomIn():this.zoomOut()}};this.addListener('.flippy-viewer','wheel',wheelHandler,{passive:!1})}
zoomIn(){let maxZoom=this.options.maxZoom;if(this.options.mode==='webtoon'){maxZoom=3.0}else if(this.options.mode==='single'){maxZoom=2.0}
if(this.currentZoom>=maxZoom){console.log(`‚ö†Ô∏è Max zoom reached: ${maxZoom.toFixed(2)}x`);return}
this.currentZoom+=this.options.zoomStep;if(this.currentZoom>maxZoom)this.currentZoom=maxZoom;console.log(`üîç Zoom In: ${this.currentZoom.toFixed(2)}x`);this.applyZoom()}
zoomOut(){const minZoom=(this.options.mode==='webtoon'||this.options.mode==='single')?1.0:this.options.minZoom;console.log(`Current zoom: ${this.currentZoom}, Min zoom: ${minZoom}`);if(this.currentZoom<=minZoom){console.warn(`‚ö†Ô∏è Already at min zoom: ${minZoom.toFixed(2)}x`);return}
this.currentZoom-=this.options.zoomStep;if(this.currentZoom<minZoom)this.currentZoom=minZoom;if(this.currentZoom<=1.0){this.panOffsetX=0;this.panOffsetY=0}
console.log(`üîç Zoom Out: ${this.currentZoom.toFixed(2)}x`);this.applyZoom()}
applyZoom(){const cursorStyle=this.currentZoom>1.0?'grab':'default';if(this.options.mode==='webtoon'){console.log(`üîÑ Applying webtoon zoom: ${this.currentZoom.toFixed(2)}x`);const wrapper=this.query('.flippy-webtoon-zoom-wrapper');if(wrapper){wrapper.style.transform=`scale(${this.currentZoom}) translate(${this.panOffsetX}px, ${this.panOffsetY}px)`;wrapper.style.cursor=this.currentZoom>1.0?'grab':'default';console.log(`‚úÖ Wrapper transform applied: scale(${this.currentZoom})`)}else{console.warn('‚ùå Webtoon wrapper NOT found!')}
const viewer=this.query('.flippy-viewer');if(viewer){viewer.style.overflow=this.currentZoom>1.0?'auto':'hidden'}}else if(this.options.mode==='single'){const allWrappers=this.queryAll('.flippy-single-zoom-wrapper');allWrappers.forEach(wrapper=>{wrapper.style.transform=`scale(${this.currentZoom}) translate(${this.panOffsetX}px, ${this.panOffsetY}px)`;wrapper.style.cursor=cursorStyle})}else if(this.options.mode==='book'){const el=this.query('.flippy-book');if(el){el.style.transform=`scale(${this.currentZoom}) translate(${this.panOffsetX}px, ${this.panOffsetY}px)`;el.style.cursor=cursorStyle}}
const indicator=this.query('.flippy-zoom-indicator');if(indicator){indicator.textContent=`${Math.round(this.currentZoom * 100)}%`;indicator.classList.add('show');setTimeout(()=>indicator.classList.remove('show'),800)}}
async open(){if(!this.options.pdfUrl){alert('‚ùå URL PDF tidak ditemukan!');return}
if(!this.overlay){this.createOverlay();this.bindControls();this.initPanAndZoom()}
const titleEl=this.query('.flippy-title-text');if(titleEl)titleEl.textContent=this.options.title;this.overlay.classList.add('active');document.body.style.overflow='hidden';this.currentSpread=0;this.currentPage=0;this.currentZoom=1.0;this.panOffsetX=0;this.panOffsetY=0;this.pageImages=[];this.pageDimensions=[];this.isFullyLoaded=!1;this.queryAll('.flippy-btn, .flippy-tool-btn').forEach(btn=>{if(!btn.classList.contains('flippy-close')){btn.disabled=!0}});const loading=this.query('.flippy-loading');const book=this.query('.flippy-book');if(loading)loading.style.display='flex';if(book)book.style.display='none';this.startLoading();try{await this.loadPDF();this.stopLoading()}catch(error){console.error('‚ùå Error:',error);this.stopLoading();this.showError(error.message)}}
startLoading(){this.loadingIndex=0;this.updateLoadingMessage();this.loadingInterval=setInterval(()=>{this.loadingIndex=(this.loadingIndex+1)%LOADING_MESSAGES.length;this.updateLoadingMessage()},1500)}
updateLoadingMessage(){const statusEl=this.query('.flippy-status');if(statusEl)statusEl.textContent=LOADING_MESSAGES[this.loadingIndex]}
stopLoading(){if(this.loadingInterval){clearInterval(this.loadingInterval);this.loadingInterval=null}}
async loadPDF(){console.log('üì• Loading PDF...');const loadingTask=pdfjsLib.getDocument(this.options.pdfUrl);this.pdfDoc=await loadingTask.promise;this.totalPages=this.pdfDoc.numPages;console.log('üìÑ Total pages:',this.totalPages);await this.convertPDFToImages();if(this.options.mode==='webtoon'){await this.buildWebtoon()}else if(this.options.mode==='single'){await this.buildSingle()}else{await this.buildBook()}
if(this.options.mode!=='webtoon'){await this.generateThumbnails()}
const loading=this.query('.flippy-loading');const book=this.query('.flippy-book');if(loading)loading.style.display='none';if(book){book.style.display='block';book.classList.add('loaded')}
this.isFullyLoaded=!0;this.queryAll('.flippy-btn, .flippy-tool-btn').forEach(btn=>{if(!btn.classList.contains('flippy-close')){btn.disabled=!0}});if(this.options.mode==='book'){this.updatePageDisplay();this.updateControls()}else if(this.options.mode==='single'){this.updateSinglePage()}else if(this.options.mode==='webtoon'){this.updateWebtoonPage()}
this.loadAudio()}
loadAudio(){if(this.options.soundEnabled&&!this.audioLoaded){this.flipSound=new Audio(this.options.soundUrl);this.flipSound.volume=0.3;this.flipSound.load();this.audioLoaded=!0}}
async convertPDFToImages(){console.log('üé® Converting pages (batch mode - SEQUENTIAL)...');this.pageImages=new Array(this.totalPages).fill(null);this.pageDimensions=new Array(this.totalPages).fill(null);const batchSize=this.options.parallelRender;const batches=[];for(let i=0;i<this.totalPages;i+=batchSize){const batch=[];for(let j=i;j<Math.min(i+batchSize,this.totalPages);j++){batch.push(j+1)}
batches.push(batch)}
console.log(`üì¶ Total batches: ${batches.length}, Batch size: ${batchSize}`);for(let batchIndex=0;batchIndex<batches.length;batchIndex++){const batch=batches[batchIndex];const progress=Math.round((batchIndex/batches.length)*100);console.log(`üìÑ Progress: ${progress}% (batch ${batchIndex + 1}/${batches.length})`);await Promise.all(batch.map(pageNum=>this.renderPageToImage(pageNum)));await new Promise(resolve=>setTimeout(resolve,50))}
console.log('‚úÖ All pages converted!')}
async renderPageToImage(pageNum){try{if(!this.pdfDoc){console.warn(`‚ö†Ô∏è PDF document not loaded, skipping page ${pageNum}`);return}
const page=await this.pdfDoc.getPage(pageNum);const viewport=page.getViewport({scale:this.options.scale});this.pageDimensions[pageNum-1]={width:viewport.width,height:viewport.height,ratio:viewport.width/viewport.height};const canvas=document.createElement('canvas');const context=canvas.getContext('2d',{alpha:!1});canvas.height=viewport.height;canvas.width=viewport.width;await page.render({canvasContext:context,viewport:viewport}).promise;await new Promise((resolve)=>{canvas.toBlob((blob)=>{if(blob){this.pageImages[pageNum-1]=URL.createObjectURL(blob);console.log(`‚úÖ Page ${pageNum} rendered: ${(blob.size / 1024).toFixed(2)}KB`)}else{console.error(`‚ùå Blob creation failed for page ${pageNum}`);this.pageImages[pageNum-1]=null}
canvas.width=0;canvas.height=0;resolve()},'image/jpeg',this.options.jpegQuality)})}catch(error){console.error(`‚ùå Error rendering page ${pageNum}:`,error);this.pageImages[pageNum-1]=null}}
async buildBook(){console.log('üìö Building BOOK mode...');const spreadsContainer=this.query('.flippy-spreads');if(!spreadsContainer){console.error('‚ùå Spreads container not found!');return}
spreadsContainer.innerHTML='';spreadsContainer.className='flippy-spreads';this.totalSpreads=Math.ceil((this.totalPages+1)/2);console.log(`üìÑ Total pages: ${this.totalPages}, Total spreads: ${this.totalSpreads}`);const loadedPages=this.pageImages.filter(img=>img!==null&&img!==undefined).length;console.log(`‚úÖ Loaded images: ${loadedPages}/${this.totalPages}`);if(loadedPages<this.totalPages){console.warn(`‚ö†Ô∏è Warning: Only ${loadedPages}/${this.totalPages} pages loaded!`)}
for(let i=0;i<this.totalSpreads;i++){const spread=this.createSpread(i);if(!spread){console.error(`‚ùå Failed to create spread ${i}`);continue}
spreadsContainer.appendChild(spread)}
this.showSpread(0);console.log(`‚úÖ BOOK mode ready with ${this.totalSpreads} spreads!`)}
createSpread(spreadIndex){const spread=document.createElement('div');spread.className='flippy-spread';spread.dataset.spread=spreadIndex;if(spreadIndex===0){const leftPage=document.createElement('div');leftPage.className='flippy-page flippy-page-left flippy-page-empty';const rightPage=document.createElement('div');rightPage.className='flippy-page flippy-page-right flippy-page-cover';if(this.pageImages[0]){const img=document.createElement('img');img.src=this.pageImages[0];img.alt='Cover';img.loading='eager';rightPage.appendChild(img)}
spread.appendChild(leftPage);spread.appendChild(rightPage)}else{const leftPageNum=spreadIndex*2;const rightPageNum=(spreadIndex*2)+1;const leftPage=document.createElement('div');leftPage.className='flippy-page flippy-page-left';if(leftPageNum<=this.totalPages&&this.pageImages[leftPageNum-1]){const img=document.createElement('img');img.src=this.pageImages[leftPageNum-1];img.alt=`Page ${leftPageNum}`;img.loading='lazy';leftPage.appendChild(img)}else{leftPage.classList.add('flippy-page-blank')}
const rightPage=document.createElement('div');rightPage.className='flippy-page flippy-page-right';if(rightPageNum<=this.totalPages&&this.pageImages[rightPageNum-1]){const img=document.createElement('img');img.src=this.pageImages[rightPageNum-1];img.alt=`Page ${rightPageNum}`;img.loading='lazy';rightPage.appendChild(img)}else{rightPage.classList.add('flippy-page-empty')}
spread.appendChild(leftPage);spread.appendChild(rightPage)}
return spread}
async buildWebtoon(){console.log('üìú Building WEBTOON mode...');const spreadsContainer=this.query('.flippy-spreads');if(!spreadsContainer){console.error('‚ùå Spreads container not found!');return}
spreadsContainer.innerHTML='';spreadsContainer.className='flippy-webtoon-container';const viewer=this.query('.flippy-viewer');if(viewer)viewer.classList.add('webtoon-mode');let htmlContent='';for(let i=0;i<this.totalPages;i++){htmlContent+=`
            <div class="flippy-webtoon-page" data-page="${i}">
                <img src="${this.pageImages[i]}" 
                     alt="Page ${i + 1}" 
                     loading="${i < 3 ? 'eager' : 'lazy'}"
                     class="flippy-webtoon-img" />
            </div>
        `}
const zoomWrapper=document.createElement('div');zoomWrapper.className='flippy-webtoon-zoom-wrapper';zoomWrapper.innerHTML=htmlContent;spreadsContainer.appendChild(zoomWrapper);const spine=this.query('.flippy-spine');if(spine)spine.style.display='none';const controls=this.query('.flippy-controls');if(controls)controls.style.display='flex';this.currentPage=0;this.currentZoom=1.0;this.panOffsetX=0;this.panOffsetY=0;spreadsContainer.style.transform='translateY(0)';if(viewer)viewer.scrollTop=0;this.updateWebtoonPage();console.log(`‚úÖ WEBTOON mode ready with ${this.totalPages} pages (ONE CONTAINER)!`)}
updateWebtoonPage(){const pageDisplay=this.query('.flippy-page-display');if(pageDisplay){pageDisplay.textContent=`Halaman ${this.currentPage + 1} dari ${this.totalPages}`}
const firstBtn=this.query('.flippy-first');const prevBtn=this.query('.flippy-prev');const nextBtn=this.query('.flippy-next');const lastBtn=this.query('.flippy-last');if(firstBtn)firstBtn.disabled=this.currentPage===0;if(prevBtn)prevBtn.disabled=this.currentPage===0;if(nextBtn)nextBtn.disabled=this.currentPage>=this.totalPages-1;if(lastBtn)lastBtn.disabled=this.currentPage>=this.totalPages-1}
async buildSingle(){console.log('üìÑ Building SINGLE mode...');const spreadsContainer=this.query('.flippy-spreads');if(!spreadsContainer){console.error('‚ùå Spreads container not found!');return}
spreadsContainer.innerHTML='';spreadsContainer.className='flippy-single-container';for(let i=0;i<this.totalPages;i++){const pageEl=document.createElement('div');pageEl.className='flippy-single-page';pageEl.dataset.page=i;const wrapper=document.createElement('div');wrapper.className='flippy-single-zoom-wrapper';const img=document.createElement('img');img.src=this.pageImages[i];img.alt=`Page ${i + 1}`;img.loading=i<3?'eager':'lazy';wrapper.appendChild(img);pageEl.appendChild(wrapper);spreadsContainer.appendChild(pageEl)}
const spine=this.query('.flippy-spine');if(spine)spine.style.display='none';const controls=this.query('.flippy-controls');if(controls)controls.style.display='flex';this.currentPage=0;this.currentZoom=1.0;this.panOffsetX=0;this.panOffsetY=0;spreadsContainer.style.transform='translateX(0)';this.updateSinglePage();console.log(`‚úÖ SINGLE mode ready with ${this.totalPages} pages!`)}
updateSinglePage(){const container=this.query('.flippy-single-container');if(container){const offset=-this.currentPage*100;container.style.transform=`translateX(${offset}%)`}
const pageDisplay=this.query('.flippy-page-display');if(pageDisplay){pageDisplay.textContent=`Halaman ${this.currentPage + 1} dari ${this.totalPages}`}
const firstBtn=this.query('.flippy-first');const prevBtn=this.query('.flippy-prev');const nextBtn=this.query('.flippy-next');const lastBtn=this.query('.flippy-last');if(firstBtn)firstBtn.disabled=this.currentPage===0;if(prevBtn)prevBtn.disabled=this.currentPage===0;if(nextBtn)nextBtn.disabled=this.currentPage>=this.totalPages-1;if(lastBtn)lastBtn.disabled=this.currentPage>=this.totalPages-1}
showSpread(spreadIndex){this.currentSpread=spreadIndex;this.queryAll('.flippy-spread').forEach(s=>{s.classList.remove('active','underneath');s.style.opacity='0';s.style.visibility='hidden'});const current=this.query(`.flippy-spread[data-spread="${spreadIndex}"]`);if(current){current.classList.add('active');current.style.opacity='1';current.style.visibility='visible'}
const isFirstSpread=spreadIndex===0;const isLastSpread=spreadIndex===this.totalSpreads-1;if(!isFirstSpread&&!isLastSpread&&spreadIndex+1<this.totalSpreads){const next=this.query(`.flippy-spread[data-spread="${spreadIndex + 1}"]`);if(next){next.classList.add('underneath');next.style.opacity='1';next.style.visibility='visible'}}
this.updatePageDisplay();this.updateControls()}
async generateThumbnails(){console.log('üñºÔ∏è Generating thumbnails...');const container=this.query('.flippy-thumbnails');if(!container)return;container.innerHTML='';for(let i=0;i<this.totalPages;i++){const thumb=document.createElement('div');thumb.className='flippy-thumb';if(this.pageDimensions[i]){const ratio=this.pageDimensions[i].ratio;const clampedRatio=Math.max(0.5,Math.min(2,ratio));thumb.style.aspectRatio=clampedRatio.toFixed(3)}else{thumb.style.aspectRatio='0.75'}
const img=document.createElement('img');img.src=this.pageImages[i];img.alt=`Page ${i + 1}`;img.loading='lazy';const num=document.createElement('span');num.className='flippy-thumb-num';num.textContent=i+1;thumb.appendChild(img);thumb.appendChild(num);thumb.addEventListener('click',()=>this.goToPage(i+1));container.appendChild(thumb)}
console.log('‚úÖ Thumbnails ready!')}
goToPage(pageNum){if(!this.isFullyLoaded||this.isFlipping)return;if(this.options.mode==='single'){this.currentPage=pageNum-1;this.updateSinglePage();this.playFlipSound()}else if(this.options.mode==='webtoon'){this.currentZoom=1.0;this.panOffsetX=0;this.panOffsetY=0;this.currentPage=pageNum-1;const container=this.query('.flippy-webtoon-container');if(container){const offset=-this.currentPage*100;container.style.transform=`translateY(${offset}vh)`}
this.updateWebtoonPage();this.playFlipSound();this.applyZoom()}else if(this.options.mode==='book'){let spreadIndex=pageNum===1?0:Math.ceil((pageNum-1)/2);this.playFlipSound();this.showSpread(spreadIndex)}
if(window.innerWidth<768){const sidebar=this.query('.flippy-sidebar');if(sidebar)sidebar.classList.remove('active');}}
nextPage(){if(this.isFlipping||!this.isFullyLoaded)return;if(this.options.mode==='webtoon'){if(this.currentPage>=this.totalPages-1)return;this.playFlipSound();this.currentPage++;const page=this.query(`.flippy-webtoon-page[data-page="${this.currentPage}"]`);if(page){page.scrollIntoView({behavior:'smooth',block:'start'})}
this.updateWebtoonPage();return}
if(this.options.mode==='single'){if(this.currentPage>=this.totalPages-1)return;this.playFlipSound();this.currentPage++;const container=this.query('.flippy-single-container');if(container){const offset=-this.currentPage*100;container.style.transform=`translateX(${offset}%)`}
this.updateSinglePage();return}
if(this.currentSpread>=this.totalSpreads-1)return;this.isFlipping=!0;this.playFlipSound();const nextSpreadIndex=this.currentSpread+1;const isGoingToLast=nextSpreadIndex===this.totalSpreads-1;if(!isGoingToLast){const nextSpread=this.query(`.flippy-spread[data-spread="${nextSpreadIndex}"]`);if(nextSpread){nextSpread.classList.add('underneath');nextSpread.style.opacity='1';nextSpread.style.visibility='visible'}}
const current=this.query(`.flippy-spread[data-spread="${this.currentSpread}"]`);const rightPage=current?.querySelector('.flippy-page-right');if(rightPage){rightPage.classList.add('flipping');setTimeout(()=>{this.currentSpread=nextSpreadIndex;this.updatePageDisplay();this.updateControls();if(current){current.classList.remove('active');current.style.opacity='0';current.style.visibility='hidden'}
const newCurrent=this.query(`.flippy-spread[data-spread="${this.currentSpread}"]`);if(newCurrent){newCurrent.classList.remove('underneath');newCurrent.classList.add('active');newCurrent.style.opacity='1';newCurrent.style.visibility='visible'}},500);setTimeout(()=>{rightPage.classList.remove('flipping');this.isFlipping=!1},1000)}}
prevPage(){if(this.isFlipping||!this.isFullyLoaded)return;if(this.options.mode==='webtoon'){if(this.currentPage===0)return;this.playFlipSound();this.currentPage--;const page=this.query(`.flippy-webtoon-page[data-page="${this.currentPage}"]`);if(page){page.scrollIntoView({behavior:'smooth',block:'start'})}
this.updateWebtoonPage();return}
if(this.options.mode==='single'){if(this.currentPage===0)return;this.playFlipSound();this.currentPage--;const container=this.query('.flippy-single-container');if(container){const offset=-this.currentPage*100;container.style.transform=`translateX(${offset}%)`}
this.updateSinglePage();return}
if(this.currentSpread===0)return;this.isFlipping=!0;this.playFlipSound();const prevSpreadIndex=this.currentSpread-1;const current=this.query(`.flippy-spread[data-spread="${this.currentSpread}"]`);const prevSpread=this.query(`.flippy-spread[data-spread="${prevSpreadIndex}"]`);const currentLeftPage=current?.querySelector('.flippy-page-left');if(prevSpread){prevSpread.classList.add('underneath');prevSpread.style.opacity='1';prevSpread.style.visibility='visible';prevSpread.style.zIndex='50'}
if(currentLeftPage){currentLeftPage.style.zIndex='200';currentLeftPage.style.transformOrigin='right center';currentLeftPage.style.animation='flipLeftToRight 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards'}
setTimeout(()=>{this.currentSpread=prevSpreadIndex;this.updatePageDisplay();this.updateControls();if(current){current.classList.remove('active');current.style.opacity='0';current.style.visibility='hidden';current.style.zIndex='1';const allPages=current.querySelectorAll('.flippy-page');allPages.forEach(page=>{page.style.animation='';page.style.zIndex='';page.style.transform='';page.style.transformOrigin=''})}
if(prevSpread){prevSpread.classList.remove('underneath');prevSpread.classList.add('active');prevSpread.style.zIndex='100'}},600);setTimeout(()=>{this.isFlipping=!1},1000)}
firstPage(){if(this.isFlipping||!this.isFullyLoaded)return;if(this.options.mode==='single'){if(this.currentPage===0)return;this.playFlipSound();this.currentPage=0;const container=this.query('.flippy-single-container');if(container){container.style.transform='translateX(0)'}
this.updateSinglePage();return}
if(this.options.mode==='webtoon'){if(this.currentPage===0)return;this.currentZoom=1.0;this.panOffsetX=0;this.panOffsetY=0;this.playFlipSound();this.currentPage=0;const container=this.query('.flippy-webtoon-container');if(container){container.style.transform='translateY(0vh)'}
this.updateWebtoonPage();this.applyZoom();return}
if(this.currentSpread===0)return;this.isFlipping=!0;this.playFlipSound();this.queryAll('.flippy-spread').forEach(s=>{s.classList.remove('active','underneath');s.style.opacity='0';s.style.visibility='hidden'});setTimeout(()=>{this.showSpread(0);this.isFlipping=!1},300)}
lastPage(){if(this.isFlipping||!this.isFullyLoaded)return;if(this.options.mode==='single'){if(this.currentPage>=this.totalPages-1)return;this.playFlipSound();this.currentPage=this.totalPages-1;const container=this.query('.flippy-single-container');if(container){const offset=-this.currentPage*100;container.style.transform=`translateX(${offset}%)`}
this.updateSinglePage();return}
if(this.options.mode==='webtoon'){if(this.currentPage>=this.totalPages-1)return;this.currentZoom=1.0;this.panOffsetX=0;this.panOffsetY=0;this.playFlipSound();this.currentPage=this.totalPages-1;const container=this.query('.flippy-webtoon-container');if(container){const offset=-this.currentPage*100;container.style.transform=`translateY(${offset}vh)`}
this.updateWebtoonPage();this.applyZoom();return}
if(this.currentSpread>=this.totalSpreads-1)return;this.isFlipping=!0;this.playFlipSound();this.queryAll('.flippy-spread').forEach(s=>{s.classList.remove('active','underneath');s.style.opacity='0';s.style.visibility='hidden'});setTimeout(()=>{this.showSpread(this.totalSpreads-1);this.isFlipping=!1},300)}
updatePageDisplay(){const pageDisplay=this.query('.flippy-page-display');if(!pageDisplay)return;let text='';if(this.currentSpread===0){text='Halaman 1 (Sampul)'}else{const left=this.currentSpread*2;const right=(this.currentSpread*2)+1;if(left<=this.totalPages&&right<=this.totalPages){text=`Halaman ${left}-${right}`}else if(left<=this.totalPages){text=`Halaman ${left}`}}
pageDisplay.textContent=text}
updateControls(){if(!this.isFullyLoaded)return;const firstBtn=this.query('.flippy-first');const prevBtn=this.query('.flippy-prev');const nextBtn=this.query('.flippy-next');const lastBtn=this.query('.flippy-last');if(firstBtn)firstBtn.disabled=this.currentSpread===0;if(prevBtn)prevBtn.disabled=this.currentSpread===0;if(nextBtn)nextBtn.disabled=this.currentSpread>=this.totalSpreads-1;if(lastBtn)lastBtn.disabled=this.currentSpread>=this.totalSpreads-1}
playFlipSound(){if(this.options.soundEnabled&&this.flipSound){this.flipSound.currentTime=0;this.flipSound.play().catch(()=>{})}}
toggleFullscreen(){if(!document.fullscreenElement){this.overlay?.requestFullscreen();const icon=this.query('.flippy-fullscreen i');if(icon)icon.className='ri-fullscreen-exit-line'}else{document.exitFullscreen();const icon=this.query('.flippy-fullscreen i');if(icon)icon.className='ri-fullscreen-line'}}
showError(message){const loading=this.query('.flippy-loading');if(loading){loading.innerHTML=`
                    <div style="text-align:center; color:white; padding:2rem;">
                        <i class="ri-error-warning-line" style="font-size:3rem; color:#ef4444;" aria-hidden="true"></i>
                        <p style="margin-top:1rem; font-size:1.1rem;">‚ùå ${sanitizeText(message)}</p>
                    </div>
                `}}
close(){if(!this.overlay)return;console.log('üßπ Cleaning up Flippy...');this.overlay.classList.remove('active');document.body.style.overflow='';const viewer=this.query('.flippy-viewer');if(viewer)viewer.classList.remove('webtoon-mode');this.eventListeners.forEach(({target,event,handler})=>{try{target.removeEventListener(event,handler)}catch(e){console.warn('Error removing listener:',e)}});this.eventListeners=[];if(this.rafId){cancelAnimationFrame(this.rafId);this.rafId=null}
setTimeout(()=>{let revokedCount=0;this.pageImages.forEach((url,index)=>{if(url&&typeof url==='string'&&url.startsWith('blob:')){try{URL.revokeObjectURL(url);revokedCount++}catch(e){console.warn(`Error revoking URL for page ${index + 1}:`,e)}}});console.log(`‚úÖ Revoked ${revokedCount} ObjectURLs`);const oldOverlay=this.overlay;if(oldOverlay?.parentNode){oldOverlay.parentNode.removeChild(oldOverlay)}
this.currentSpread=0;this.currentPage=0;this.currentZoom=1.0;this.panOffsetX=0;this.panOffsetY=0;this.isFlipping=!1;this.isFullyLoaded=!1;this.pageImages=[];this.pageDimensions=[];this.cachedElements={};if(this.pdfDoc){try{this.pdfDoc.destroy();this.pdfDoc=null}catch(e){console.warn('Error destroying PDF:',e)}}
if(this.flipSound){this.flipSound.pause();this.flipSound.currentTime=0;this.flipSound=null;this.audioLoaded=!1}
this.overlay=null;console.log('‚úÖ Flippy destroyed completely (memory freed)!')},300)}
query(sel){return this.overlay?.querySelector(sel)||null}
queryAll(sel){return this.overlay?.querySelectorAll(sel)||[]}
addListener(sel,event,handler,options){const el=this.query(sel);if(el){el.addEventListener(event,handler,options);this.eventListeners.push({target:el,event,handler})}}}
window.Flippy=Flippy;console.log('%c‚úÖ Flippy v1.0.0 Ready (FIXED & OPTIMIZED)!','color: #4ade80; font-weight: bold; font-size: 14px;');console.log(`%cüöÄ By ${AUTHOR} (${USERNAME}) ¬∑ ${LOCATION} ¬∑ ${YEAR}`,'color: #60a5fa; font-size: 12px;');console.log('%c‚ö° Performance: Sequential Rendering, ObjectURL, Memory Safe','color: #fbbf24; font-size: 11px;')})()